<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>Building Inspector Pro</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { min-height: 100vh; background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%); color: #fff; font-family: 'Courier New', monospace; padding: 20px; }
    .header { background: linear-gradient(90deg, #f97316 0%, #ea580c 100%); padding: 24px; border-radius: 8px; margin-bottom: 24px; box-shadow: 0 4px 20px rgba(249, 115, 22, 0.3); }
    .header h1 { margin: 0; font-size: 28px; font-weight: bold; }
    .header p { margin: 8px 0 0 0; opacity: 0.9; font-size: 14px; }
    .role-badge { display: inline-block; padding: 4px 12px; background: rgba(255,255,255,0.2); border-radius: 12px; font-size: 12px; margin-left: 12px; }
    .nav { display: flex; gap: 12px; margin-bottom: 24px; flex-wrap: wrap; }
    .nav-btn { padding: 12px 24px; background: #333; border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 14px; font-weight: bold; transition: all 0.2s; font-family: inherit; }
    .nav-btn.active { background: #f97316; }
    .nav-btn:disabled { opacity: 0.4; cursor: not-allowed; }
    .card { background: #2d2d2d; border-radius: 8px; padding: 24px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); margin-bottom: 16px; }
    .form-grid { display: grid; gap: 16px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .form-group label { display: block; margin-bottom: 8px; font-size: 12px; color: #999; text-transform: uppercase; }
    .form-control { width: 100%; padding: 12px; background: #1a1a1a; border: 2px solid #444; border-radius: 6px; color: #fff; font-size: 16px; font-family: inherit; }
    textarea.form-control { min-height: 100px; resize: vertical; }
    .btn { padding: 16px; background: linear-gradient(90deg, #f97316 0%, #ea580c 100%); border: none; border-radius: 6px; color: #fff; cursor: pointer; font-size: 16px; font-weight: bold; box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3); transition: transform 0.2s; font-family: inherit; width: 100%; }
    .btn:active { transform: scale(0.98); }
    .btn-sm { padding: 12px 24px; font-size: 14px; width: auto; }
    .btn-green { background: #10b981; }
    .btn-blue { background: #3b82f6; }
    .btn-red { background: #ef4444; }
    .btn-purple { background: #8b5cf6; }
    .defect-item { background: #2d2d2d; border-radius: 8px; padding: 16px; display: flex; gap: 16px; align-items: flex-start; margin-bottom: 12px; }
    .defect-img { width: 120px; height: 120px; object-fit: cover; border-radius: 6px; cursor: pointer; border: 2px solid #444; }
    .defect-info { flex: 1; }
    .defect-number { font-size: 18px; font-weight: bold; color: #f97316; margin-bottom: 8px; }
    .defect-meta { display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 8px; font-size: 13px; color: #999; margin-bottom: 8px; }
    .category-badge { display: inline-block; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; margin-top: 4px; }
    .category-crack { background: #ef4444; }
    .category-spalling { background: #f97316; }
    .category-water { background: #3b82f6; }
    .category-corrosion { background: #a855f7; }
    .category-other { background: #6b7280; }
    .delete-btn { padding: 8px; background: transparent; border: none; color: #ef4444; cursor: pointer; border-radius: 4px; font-size: 20px; }
    .empty-state { background: #2d2d2d; border-radius: 8px; padding: 48px; text-align: center; color: #666; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.95); align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
    .modal.active { display: flex; }
    .modal img { max-width: 100%; max-height: 100%; border-radius: 8px; }
    .toolbar { display: flex; gap: 12px; flex-wrap: wrap; align-items: center; }
    .toolbar-right { margin-left: auto; }
    .hidden { display: none; }
    .setup-screen { max-width: 600px; margin: 50px auto; }
    .setup-screen h2 { color: #f97316; margin-bottom: 24px; font-size: 32px; text-align: center; }
    .role-cards { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 32px; }
    .role-card { background: #2d2d2d; padding: 32px 24px; border-radius: 12px; cursor: pointer; transition: all 0.3s; border: 3px solid transparent; width: 100%; text-align: left; font-family: inherit; color: inherit; }
    .role-card:hover, .role-card:active { border-color: #f97316; transform: translateY(-4px); }
    .role-card h3 { font-size: 24px; margin-bottom: 12px; color: #f97316; pointer-events: none; }
    .role-card ul { color: #999; font-size: 14px; line-height: 1.8; list-style-position: inside; pointer-events: none; }
    .sync-indicator { display: inline-flex; align-items: center; gap: 8px; padding: 6px 12px; background: rgba(16, 185, 129, 0.2); border-radius: 12px; font-size: 12px; color: #10b981; }
    .sync-indicator.offline { background: rgba(239, 68, 68, 0.2); color: #ef4444; }
    .sync-dot { width: 8px; height: 8px; background: currentColor; border-radius: 50%; animation: pulse 2s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .loading { text-align: center; padding: 48px; color: #999; }
    .spinner { border: 3px solid #333; border-top-color: #f97316; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 0 auto 16px; }
    @keyframes spin { to { transform: rotate(360deg); } }
    .map-canvas { display: block; width: 100%; height: auto; }
    .facade-photo-upload { margin-bottom: 16px; padding: 16px; background: rgba(249, 115, 22, 0.1); border: 2px dashed #f97316; border-radius: 8px; text-align: center; cursor: pointer; width: 100%; font-family: inherit; color: inherit; }
    .facade-photo-upload.has-photo { border-style: solid; background: rgba(16, 185, 129, 0.1); border-color: #10b981; }
    .facade-photo-upload p { pointer-events: none; }
    .grid-controls { display: flex; gap: 8px; justify-content: center; margin-top: 12px; flex-wrap: wrap; }
    .grid-controls button { padding: 8px 16px; background: #333; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 12px; font-family: inherit; }
    .face-tabs { display: flex; gap: 8px; margin-bottom: 16px; flex-wrap: wrap; }
    .face-tab { padding: 8px 16px; background: #333; border: none; border-radius: 4px; color: #fff; cursor: pointer; font-size: 12px; font-family: inherit; }
    .face-tab.active { background: #f97316; }
    .project-list { display: grid; gap: 12px; max-height: 400px; overflow-y: auto; }
    .project-item { background: #333; padding: 16px; border-radius: 8px; cursor: pointer; border: 2px solid transparent; }
    .project-item:hover { border-color: #f97316; }
    .project-item h4 { color: #f97316; margin-bottom: 8px; }
    .toggle-switch { position: relative; display: inline-block; width: 50px; height: 24px; margin-left: 12px; }
    .toggle-switch input { opacity: 0; width: 0; height: 0; }
    .toggle-slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #333; transition: .4s; border-radius: 24px; }
    .toggle-slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .4s; border-radius: 50%; }
    input:checked + .toggle-slider { background-color: #f97316; }
    input:checked + .toggle-slider:before { transform: translateX(26px); }
    @media (max-width: 768px) { .form-row { grid-template-columns: 1fr; } .defect-item { flex-direction: column; } .defect-img { width: 100%; height: 200px; } .role-cards { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div id="setupScreen" class="setup-screen">
    <div class="card">
      <h2>üèóÔ∏è Building Inspector Pro</h2>
      <div class="form-group" style="margin-bottom:24px">
        <label>Your Name</label>
        <input type="text" id="userName" class="form-control" placeholder="Enter your name">
      </div>
      <div class="form-group" style="margin-bottom:24px">
        <label>Project ID</label>
        <input type="text" id="projectId" class="form-control" placeholder="Enter project ID">
      </div>
      <div class="role-cards">
        <button class="role-card" type="button" id="workerButton">
          <h3>ü™Ç Worker</h3>
          <ul><li>Log defects</li><li>View maps</li></ul>
        </button>
        <button class="role-card" type="button" id="managerButton">
          <h3>üëî Manager</h3>
          <ul><li>All worker features</li><li>Create projects</li><li>Export reports</li><li>Password: 1234</li></ul>
        </button>
      </div>
      <div id="debugInfo" style="margin-top:20px;padding:12px;background:#333;border-radius:4px;font-size:12px;color:#0f0;font-family:monospace;display:none"></div>
    </div>
  </div>

  <div id="projectsScreen" class="setup-screen hidden">
    <div class="card">
      <h2>üìã Projects</h2>
      <button class="btn" onclick="showCreateProject()" style="margin-bottom:24px">‚ûï Create New</button>
      <div id="projectsList" class="project-list"></div>
      <button class="btn btn-red" onclick="backToSetup()" style="margin-top:24px">‚Üê Back</button>
    </div>
  </div>

  <div id="createProjectScreen" class="setup-screen hidden">
    <div class="card">
      <h2>‚ûï Create Project</h2>
      <div class="form-group" style="margin-bottom:16px">
        <label>Project ID</label>
        <input type="text" id="newProjectId" class="form-control">
      </div>
      <div class="form-group" style="margin-bottom:16px">
        <label>Project Name</label>
        <input type="text" id="newProjectName" class="form-control">
      </div>
      <div class="form-group" style="margin-bottom:24px">
        <label>Number of Faces</label>
        <input type="number" id="newProjectFaces" class="form-control" value="4" min="1" max="20">
      </div>
      <button class="btn" onclick="createNewProject()">Create</button>
      <button class="btn btn-red" onclick="backToProjects()" style="margin-top:16px">‚Üê Back</button>
    </div>
  </div>

  <div id="loadingScreen" class="loading hidden">
    <div class="spinner"></div>
    <p>Connecting...</p>
  </div>

  <div id="mainApp" class="hidden">
    <div class="header">
      <div style="display:flex;justify-content:space-between;flex-wrap:wrap;gap:12px">
        <div>
          <h1>Building Inspector Pro <span class="role-badge" id="roleBadge"></span></h1>
          <p><span id="userNameDisplay"></span> ‚Ä¢ <span id="projectName"></span> ‚Ä¢ Defects: <span id="defectCount">0</span> ‚Ä¢ <span id="syncIndicator" class="sync-indicator"><span class="sync-dot"></span><span id="syncText">Connected</span></span></p>
        </div>
        <button class="btn btn-sm btn-red" onclick="exitSession()">Exit</button>
      </div>
    </div>

    <div class="nav">
      <button class="nav-btn active" onclick="showView('entry')">üì∏ Log Defect</button>
      <button class="nav-btn" onclick="showView('list')">üìã View All</button>
      <button class="nav-btn" onclick="showView('liveMap')">üó∫Ô∏è Live Map</button>
      <button class="nav-btn" id="configBtn" onclick="showView('config')" style="display:none">‚öôÔ∏è Settings</button>
    </div>

    <div id="entryView">
      <div class="card">
        <h2 style="margin:0 0 24px;font-size:20px;color:#f97316">Defect #<span id="nextDefectNumber">1</span></h2>
        <div class="form-grid">
          <div class="form-row">
            <div class="form-group"><label>Building</label><input type="text" id="building" class="form-control" value="1"></div>
            <div class="form-group"><label>Face</label><select id="face" class="form-control"></select></div>
          </div>
          <div class="form-row">
            <div class="form-group"><label>Drop</label><input type="text" id="drop" class="form-control" value="1"></div>
            <div class="form-group"><label>Level</label><input type="text" id="level" class="form-control" value="1"></div>
          </div>
          <div class="form-group">
            <label>Category</label>
            <select id="category" class="form-control">
              <option value="crack">Crack</option>
              <option value="spalling">Spalling</option>
              <option value="water">Water Damage</option>
              <option value="corrosion">Corrosion</option>
              <option value="other">Other</option>
            </select>
          </div>
          <div class="form-group"><label>Description</label><textarea id="description" class="form-control"></textarea></div>
          <input type="file" id="photoInput" accept="image/*" capture="environment" style="display:none">
          <button class="btn" onclick="document.getElementById('photoInput').click()">üì∑ Capture Photo</button>
        </div>
      </div>
    </div>

    <div id="listView" class="hidden">
      <div class="card toolbar" id="managerToolbar" style="display:none">
        <button class="btn btn-sm btn-green" onclick="exportWordDoc()">‚¨áÔ∏è Word</button>
        <button class="btn btn-sm btn-blue" onclick="exportPDF()">üìÑ PDF</button>
        <button class="btn btn-sm btn-purple" onclick="exportDefectMapsPDF()">üìç PDF Maps</button>
        <button class="btn btn-sm btn-red toolbar-right" onclick="clearAllData()">üóëÔ∏è Clear</button>
      </div>
      <div id="defectListContainer"></div>
    </div>

    <div id="liveMapView" class="hidden">
      <div class="card">
        <div style="display:flex;justify-content:space-between;margin-bottom:16px;flex-wrap:wrap">
          <h2 style="margin:0;color:#f97316">Live Map</h2>
          <div style="display:flex;align-items:center;gap:8px">
            <span style="font-size:14px">Grid</span>
            <label class="toggle-switch"><input type="checkbox" id="gridToggle" checked onchange="renderLiveMap()"><span class="toggle-slider"></span></label>
          </div>
        </div>
        <div class="face-tabs" id="faceTabs"></div>
        <button class="facade-photo-upload" id="facadeUploadZone" onclick="document.getElementById('facadePhotoInput').click()" type="button">
          <p style="margin:0;color:#f97316;font-weight:bold">üì∏ Upload Facade Photo</p>
        </button>
        <input type="file" id="facadePhotoInput" accept="image/*" style="display:none">
        <div style="text-align:center;margin-bottom:12px">
          <span style="color:#999;font-size:14px"><span id="currentFaceName">Face 1</span> Defects: <span id="faceDefectCount">0</span></span>
        </div>
        <canvas id="liveMapCanvas" class="map-canvas"></canvas>
        <div class="grid-controls" id="gridControls" style="display:none">
          <button onclick="adjustGrid('left')">‚Üê Left</button>
          <button onclick="adjustGrid('right')">Right ‚Üí</button>
          <button onclick="adjustGrid('up')">‚Üë Up</button>
          <button onclick="adjustGrid('down')">‚Üì Down</button>
          <button onclick="adjustGrid('wider')">‚¨å Wider</button>
          <button onclick="adjustGrid('narrower')">‚¨ç Narrower</button>
          <button onclick="adjustGrid('taller')">‚¨Ü Taller</button>
          <button onclick="adjustGrid('shorter')">‚¨á Shorter</button>
          <button onclick="resetGrid()" style="background:#ef4444">‚Ü∫ Reset</button>
        </div>
      </div>
    </div>

    <div id="configView" class="hidden">
      <div class="card">
        <h2 style="margin:0 0 24px;font-size:20px;color:#f97316">‚öôÔ∏è Settings</h2>
        <div class="form-grid">
          <div class="form-group"><label>Project Name</label><input type="text" id="projectNameInput" class="form-control"></div>
          <div class="form-group"><label>Number of Faces</label><input type="number" id="numFaces" class="form-control" value="4" min="1" max="20" onchange="updateFaces()"></div>
          <h3 style="color:#999;font-size:14px;margin-top:16px">PER-FACE CONFIG</h3>
          <div id="faceNamesList"></div>
          <button class="btn btn-purple" onclick="saveConfig()">üíæ Save All</button>
        </div>
      </div>
    </div>
  </div>

  <div id="imageModal" class="modal" onclick="closeModal()"><img id="modalImage" src=""></div>

  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
  (function() {
    'use strict';
    
    // Debug function
    function debug(msg) {
      console.log('[DEBUG]', msg);
      const d = document.getElementById('debugInfo');
      if (d) {
        d.style.display = 'block';
        d.innerHTML += new Date().toLocaleTimeString() + ': ' + msg + '<br>';
      }
    }
    
    debug('Script starting...');

    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyDork6Cl33rHNPKU88sFYVcOkKW_Wj68BY",
      authDomain: "building-inspector-79c34.firebaseapp.com",
      databaseURL: "https://building-inspector-79c34-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "building-inspector-79c34",
      storageBucket: "building-inspector-79c34.firebasestorage.app",
      messagingSenderId: "73507039597",
      appId: "1:73507039597:web:1c043682b0d58a6e549264"
    };

    let db;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
      debug('Firebase initialized');
    } catch (error) {
      debug('Firebase error: ' + error.message);
    }

    const MANAGER_PASSWORD = "1234";
    const CAT_LABELS = {crack:'Cracked Concrete',spalling:'Spalling',water:'Water Damage',corrosion:'Corrosion',other:'Other'};
    const CAT_COLORS = {crack:'#ef4444',spalling:'#f97316',water:'#3b82f6',corrosion:'#a855f7',other:'#6b7280'};

    let projectId = '', userName = '', userRole = '';
    let defects = [];
    let config = {
      projectName: '',
      createdBy: '',
      numFaces: 4,
      faceNames: ['Face 1', 'Face 2', 'Face 3', 'Face 4'],
      faceConfigs: {
        'Face 1': { maxDrops: 15, maxLevels: 10 },
        'Face 2': { maxDrops: 15, maxLevels: 10 },
        'Face 3': { maxDrops: 15, maxLevels: 10 },
        'Face 4': { maxDrops: 15, maxLevels: 10 }
      },
      facadePhotos: {}
    };
    let currentView = 'entry', currentFaceIndex = 0;
    let defectsRef = null, configRef = null, facadePhoto = null;
    let gridAdjustments = { offsetX: 0, offsetY: 0, scaleX: 1, scaleY: 1 };
    let showGrid = true;

    // Make functions global
    window.startSession = startSession;
    window.loadManagerProjects = loadManagerProjects;
    window.selectProject = selectProject;
    window.showCreateProject = showCreateProject;
    window.createNewProject = createNewProject;
    window.backToProjects = backToProjects;
    window.backToSetup = backToSetup;
    window.exitSession = exitSession;
    window.showView = showView;
    window.updateFaces = updateFaces;
    window.saveConfig = saveConfig;
    window.adjustGrid = adjustGrid;
    window.resetGrid = resetGrid;
    window.renderLiveMap = renderLiveMap;
    window.deleteDefect = deleteDefect;
    window.clearAllData = clearAllData;
    window.showImage = showImage;
    window.closeModal = closeModal;
    window.exportWordDoc = exportWordDoc;
    window.exportPDF = exportPDF;
    window.exportDefectMapsPDF = exportDefectMapsPDF;
    
    debug('Functions defined');

    // Setup event listeners
    document.addEventListener('DOMContentLoaded', function() {
      debug('DOM loaded');
      
      const workerBtn = document.getElementById('workerButton');
      const managerBtn = document.getElementById('managerButton');
      
      debug('Worker button: ' + (workerBtn ? 'found' : 'NOT FOUND'));
      debug('Manager button: ' + (managerBtn ? 'found' : 'NOT FOUND'));
      
      if (workerBtn) {
        workerBtn.onclick = function() {
          debug('Worker button clicked!');
          startSession('worker');
        };
        debug('Worker button handler attached');
      }
      
      if (managerBtn) {
        managerBtn.onclick = function() {
          debug('Manager button clicked!');
          const password = prompt('Manager password:');
          if (password === MANAGER_PASSWORD) {
            loadManagerProjects();
          } else {
            alert('Wrong password');
          }
        };
        debug('Manager button handler attached');
      }

      // Photo inputs
      const photoInput = document.getElementById('photoInput');
      if (photoInput) {
        photoInput.addEventListener('change', handlePhoto);
        debug('Photo input handler attached');
      }

      const facadeInput = document.getElementById('facadePhotoInput');
      if (facadeInput) {
        facadeInput.addEventListener('change', handleFacade);
        debug('Facade input handler attached');
      }

      debug('All handlers attached');
    });

    function startSession(role) {
      debug('startSession called with role: ' + role);
      
      const inputUserName = document.getElementById('userName').value.trim();
      const inputProjectId = document.getElementById('projectId').value.trim();
      
      if (!inputUserName || !inputProjectId) {
        alert('Enter name and project ID');
        return;
      }

      if (!db) {
        alert('Firebase not configured');
        return;
      }

      projectId = inputProjectId.replace(/[.#$[\]]/g, '-');
      userName = inputUserName;
      userRole = role;

      debug('Starting session: ' + userName + ' / ' + role + ' / ' + projectId);

      document.getElementById('setupScreen').classList.add('hidden');
      document.getElementById('loadingScreen').classList.remove('hidden');

      defectsRef = db.ref(`inspections/${projectId}/defects`);
      configRef = db.ref(`inspections/${projectId}/config`);

      configRef.once('value').then(configSnapshot => {
        if (configSnapshot.exists()) {
          config = configSnapshot.val();
          ensureFaceConfigs();
          loadProject();
        } else {
          if (role === 'manager') {
            config.createdBy = userName;
            config.projectName = projectId;
            ensureFaceConfigs();
            configRef.set(config).then(() => loadProject());
          } else {
            alert('Project does not exist');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');
          }
        }
      }).catch(error => {
        debug('Error: ' + error.message);
        alert('Error: ' + error.message);
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('setupScreen').classList.remove('hidden');
      });
    }

    function ensureFaceConfigs() {
      if (!config.faceConfigs) config.faceConfigs = {};
      if (!config.faceNames) config.faceNames = Array.from({length: config.numFaces || 4}, (_, i) => `Face ${i + 1}`);
      config.faceNames.forEach(name => {
        if (!config.faceConfigs[name]) {
          config.faceConfigs[name] = {
            maxDrops: config.maxDrops || 15,
            maxLevels: config.maxLevels || 10
          };
        }
      });
    }

    function loadProject() {
      defectsRef.once('value').then(defectsSnapshot => {
        if (defectsSnapshot.exists()) {
          defects = Object.values(defectsSnapshot.val());
        }

        setupListeners();

        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('roleBadge').textContent = userRole.toUpperCase();
        document.getElementById('projectName').textContent = projectId;
        document.getElementById('userNameDisplay').textContent = userName;

        if (userRole === 'manager') {
          document.getElementById('configBtn').style.display = 'block';
          document.getElementById('managerToolbar').style.display = 'flex';
        }

        populateFaceSelectors();
        updateUI();
        setSync('connected');
      });
    }

    function setupListeners() {
      defectsRef.on('value', snapshot => {
        defects = snapshot.exists() ? Object.values(snapshot.val()) : [];
        updateUI();
        if (currentView === 'list') renderList();
        if (currentView === 'liveMap') renderLiveMap();
        setSync('connected');
      });

      configRef.on('value', snapshot => {
        if (snapshot.exists()) {
          config = snapshot.val();
          ensureFaceConfigs();
          populateFaceSelectors();
          if (currentView === 'liveMap') renderLiveMap();
        }
      });

      db.ref('.info/connected').on('value', snap => {
        setSync(snap.val() ? 'connected' : 'offline');
      });
    }

    function setSync(state) {
      const i = document.getElementById('syncIndicator'), t = document.getElementById('syncText');
      i.classList.remove('offline');
      if (state === 'offline') {
        i.classList.add('offline');
        t.textContent = 'Offline';
      } else {
        t.textContent = 'Connected';
      }
    }

    function populateFaceSelectors() {
      ensureFaceConfigs();
      const fs = document.getElementById('face');
      if (fs) fs.innerHTML = config.faceNames.map(n => `<option>${n}</option>`).join('');
      renderFaceTabs();
      renderFaceConfig();
    }

    function renderFaceTabs() {
      const c = document.getElementById('faceTabs');
      if (!c) return;
      c.innerHTML = config.faceNames.map((n, i) => 
        `<button class="face-tab ${i===currentFaceIndex?'active':''}" onclick="selectFace(${i})">${n}</button>`
      ).join('');
    }

    window.selectFace = function(i) {
      currentFaceIndex = i;
      renderFaceTabs();
      loadFacadePhoto();
      renderLiveMap();
    };

    function renderFaceConfig() {
      const c = document.getElementById('faceNamesList');
      if (!c) return;
      c.innerHTML = config.faceNames.map((name, i) => {
        const fc = config.faceConfigs[name] || {maxDrops:15, maxLevels:10};
        return `<div class="card" style="background:#1a1a1a;padding:16px;margin-top:16px">
          <h4 style="color:#f97316;margin-bottom:12px">Face ${i+1}</h4>
          <div class="form-group" style="margin-bottom:12px">
            <label>Name</label>
            <input type="text" class="form-control" value="${name}" onchange="updateFaceName(${i}, this.value)">
          </div>
          <div class="form-row">
            <div class="form-group">
              <label>Max Drops</label>
              <input type="number" class="form-control" value="${fc.maxDrops}" min="1" max="50" onchange="updateFaceGridConfig('${name}', 'maxDrops', this.value)">
            </div>
            <div class="form-group">
              <label>Max Levels</label>
              <input type="number" class="form-control" value="${fc.maxLevels}" min="1" max="50" onchange="updateFaceGridConfig('${name}', 'maxLevels', this.value)">
            </div>
          </div>
        </div>`;
      }).join('');
    }

    window.updateFaceName = function(i, v) {
      const oldName = config.faceNames[i];
      config.faceNames[i] = v;
      if (config.faceConfigs[oldName]) {
        config.faceConfigs[v] = config.faceConfigs[oldName];
        delete config.faceConfigs[oldName];
      }
      if (config.facadePhotos && config.facadePhotos[oldName]) {
        config.facadePhotos[v] = config.facadePhotos[oldName];
        delete config.facadePhotos[oldName];
      }
    };

    window.updateFaceGridConfig = function(faceName, prop, val) {
      if (!config.faceConfigs[faceName]) config.faceConfigs[faceName] = {maxDrops:15, maxLevels:10};
      config.faceConfigs[faceName][prop] = parseInt(val);
    };

    function updateFaces() {
      const n = parseInt(document.getElementById('numFaces').value);
      config.numFaces = n;
      while (config.faceNames.length < n) {
        config.faceNames.push(`Face ${config.faceNames.length + 1}`);
      }
      if (config.faceNames.length > n) {
        config.faceNames = config.faceNames.slice(0, n);
      }
      ensureFaceConfigs();
      renderFaceConfig();
    }

    function saveConfig() {
      if (userRole !== 'manager') return;
      config.projectName = document.getElementById('projectNameInput').value;
      config.numFaces = parseInt(document.getElementById('numFaces').value);
      ensureFaceConfigs();
      setSync('syncing');
      configRef.set(config).then(() => alert('Saved!'));
    }

    function handlePhoto(e) {
      const f = e.target.files[0];
      if (!f) return;
      if (f.size > 5e6) {
        alert('Too big (max 5MB)');
        e.target.value = '';
        return;
      }
      setSync('syncing');
      const r = new FileReader();
      r.onloadend = () => {
        const d = {
          id: Date.now(),
          building: document.getElementById('building').value,
          face: document.getElementById('face').value,
          drop: document.getElementById('drop').value,
          level: document.getElementById('level').value,
          category: document.getElementById('category').value,
          defectNumber: defects.length + 1,
          description: document.getElementById('description').value || 'No description',
          image: r.result,
          timestamp: new Date().toISOString(),
          addedBy: userName
        };
        defectsRef.child(d.id.toString()).set(d).then(() => {
          document.getElementById('description').value = '';
          e.target.value = '';
          alert(`‚úÖ Defect #${d.defectNumber} logged`);
        }).catch(err => alert('Error: ' + err.message));
      };
      r.readAsDataURL(f);
    }

    function deleteDefect(id) {
      if (userRole !== 'manager') return;
      if (!confirm('Delete?')) return;
      setSync('syncing');
      defectsRef.child(id.toString()).remove().then(() => {
        const r = defects.filter(d => d.id !== id), u = {};
        r.forEach((d, i) => { d.defectNumber = i + 1; u[d.id] = d; });
        defectsRef.set(u);
      });
    }

    function clearAllData() {
      if (userRole !== 'manager') return;
      if (!confirm(`Delete all ${defects.length}?`)) return;
      setSync('syncing');
      defectsRef.remove();
    }

    function handleFacade(e) {
      const f = e.target.files[0];
      if (!f) return;
      const r = new FileReader();
      r.onloadend = () => {
        ensureFaceConfigs();
        const faceName = config.faceNames[currentFaceIndex];
        if (!config.facadePhotos) config.facadePhotos = {};
        config.facadePhotos[faceName] = r.result;
        if (userRole === 'manager') {
          configRef.update({facadePhotos: config.facadePhotos}).then(() => {
            loadFacadePhoto();
            renderLiveMap();
          });
        } else {
          loadFacadePhoto();
          renderLiveMap();
        }
      };
      r.readAsDataURL(f);
    }

    function loadFacadePhoto() {
      ensureFaceConfigs();
      const faceName = config.faceNames[currentFaceIndex];
      const u = document.getElementById('facadeUploadZone');
      const g = document.getElementById('gridControls');
      if (config.facadePhotos && config.facadePhotos[faceName]) {
        facadePhoto = config.facadePhotos[faceName];
        if (u) u.classList.add('has-photo');
        if (g) g.style.display = 'flex';
      } else {
        facadePhoto = null;
        if (u) u.classList.remove('has-photo');
        if (g) g.style.display = 'none';
      }
    }

    function adjustGrid(d) {
      const s = 10, ss = 0.05;
      switch(d) {
        case 'left': gridAdjustments.offsetX -= s; break;
        case 'right': gridAdjustments.offsetX += s; break;
        case 'up': gridAdjustments.offsetY -= s; break;
        case 'down': gridAdjustments.offsetY += s; break;
        case 'wider': gridAdjustments.scaleX += ss; break;
        case 'narrower': gridAdjustments.scaleX -= ss; break;
        case 'taller': gridAdjustments.scaleY += ss; break;
        case 'shorter': gridAdjustments.scaleY -= ss; break;
      }
      renderLiveMap();
    }

    function resetGrid() {
      gridAdjustments = {offsetX:0, offsetY:0, scaleX:1, scaleY:1};
      renderLiveMap();
    }

    function renderLiveMap() {
      const cv = document.getElementById('liveMapCanvas');
      if (!cv) return;
      const ctx = cv.getContext('2d');
      ensureFaceConfigs();
      if (currentFaceIndex >= config.faceNames.length) currentFaceIndex = 0;
      const faceName = config.faceNames[currentFaceIndex];
      const fc = config.faceConfigs[faceName] || {maxDrops:15, maxLevels:10};
      const gt = document.getElementById('gridToggle');
      showGrid = gt ? gt.checked : true;
      const w=800,h=600;
      cv.width=w; cv.height=h;
      const m=40, gw=(w-m*2)*gridAdjustments.scaleX, gh=(h-m*2)*gridAdjustments.scaleY;
      const gx=m+gridAdjustments.offsetX, gy=m+gridAdjustments.offsetY;
      ctx.fillStyle='#1a1a1a';
      ctx.fillRect(0,0,w,h);
      if (facadePhoto) {
        const img = new Image();
        img.onload = () => { ctx.drawImage(img,0,0,w,h); draw(); };
        img.onerror = () => draw();
        img.src = facadePhoto;
      } else draw();
      function draw() {
        const cw=gw/fc.maxDrops, ch=gh/fc.maxLevels;
        if (showGrid) {
          ctx.strokeStyle=facadePhoto?'#f97316':'#444';
          ctx.lineWidth=3;
          ctx.strokeRect(gx,gy,gw,gh);
          ctx.strokeStyle=facadePhoto?'rgba(249,115,22,0.5)':'#333';
          ctx.lineWidth=1;
          for(let i=1;i<fc.maxLevels;i++){
            const y=gy+(i*ch);
            ctx.beginPath();ctx.moveTo(gx,y);ctx.lineTo(gx+gw,y);ctx.stroke();
          }
          for(let i=1;i<fc.maxDrops;i++){
            const x=gx+(i*cw);
            ctx.beginPath();ctx.moveTo(x,gy);ctx.lineTo(x,gy+gh);ctx.stroke();
          }
          ctx.fillStyle=facadePhoto?'#fff':'#666';
          ctx.font='12px Arial';
          ctx.textAlign='right';
          for(let i=0;i<fc.maxLevels;i++){
            const l=fc.maxLevels-i,y=gy+(i*ch)+(ch/2)+4;
            ctx.fillText(l.toString(),gx-5,y);
          }
          ctx.textAlign='center';
          for(let i=0;i<fc.maxDrops;i++){
            const x=gx+(i*cw)+(cw/2);
            ctx.fillText((i+1).toString(),x,gy-5);
          }
        }
        const fds=defects.filter(d=>d.face===faceName), dbl={};
        fds.forEach(d=>{const k=`${d.drop}-${d.level}`;if(!dbl[k])dbl[k]=[];dbl[k].push(d)});
        const ce=document.getElementById('faceDefectCount'), ne=document.getElementById('currentFaceName');
        if(ce)ce.textContent=fds.length;
        if(ne)ne.textContent=faceName;
        Object.entries(dbl).forEach(([k,lds])=>{
          const[dr,lv]=k.split('-').map(Number);
          if(dr>fc.maxDrops||lv>fc.maxLevels)return;
          const bx=gx+((dr-1)*cw), by=gy+((fc.maxLevels-lv)*ch), cnt=lds.length;
          const pad=4, minMS=12, maxMS=20;
          const cols=Math.ceil(Math.sqrt(cnt)), rows=Math.ceil(cnt/cols);
          const aw=(cw*0.9)-(pad*(cols-1)), ah=(ch*0.9)-(pad*(rows-1));
          const ms=Math.min(maxMS,Math.max(minMS,aw/cols,ah/rows));
          const tw=(ms*cols)+(pad*(cols-1)), th=(ms*rows)+(pad*(rows-1));
          const sx=bx+(cw-tw)/2, sy=by+(ch-th)/2;
          lds.forEach((d,i)=>{
            const col=i%cols, row=Math.floor(i/cols);
            const x=sx+(col*(ms+pad))+(ms/2), y=sy+(row*(ms+pad))+(ms/2);
            ctx.fillStyle=CAT_COLORS[d.category]||'#f97316';
            ctx.beginPath();ctx.arc(x,y,ms/2,0,Math.PI*2);ctx.fill();
            ctx.strokeStyle='#fff';ctx.lineWidth=2;ctx.stroke();
            ctx.fillStyle='#fff';
            ctx.font=`bold ${Math.max(8,ms*0.6)}px Arial`;
            ctx.textAlign='center';ctx.textBaseline='middle';
            ctx.fillText(d.defectNumber.toString(),x,y);
          });
        });
      }
    }

    function showView(v) {
      currentView = v;
      document.getElementById('entryView').classList.toggle('hidden', v !== 'entry');
      document.getElementById('listView').classList.toggle('hidden', v !== 'list');
      document.getElementById('liveMapView').classList.toggle('hidden', v !== 'liveMap');
      document.getElementById('configView').classList.toggle('hidden', v !== 'config');
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      if (v === 'entry') document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
      if (v === 'list') {
        document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
        renderList();
      }
      if (v === 'liveMap') {
        document.querySelector('.nav-btn:nth-child(3)').classList.add('active');
        loadFacadePhoto();
        renderLiveMap();
      }
      if (v === 'config') {
        document.getElementById('configBtn').classList.add('active');
        document.getElementById('projectNameInput').value = config.projectName || '';
        document.getElementById('numFaces').value = config.numFaces || 4;
        renderFaceConfig();
      }
    }

    function renderList() {
      const c = document.getElementById('defectListContainer');
      if (!c) return;
      if (!defects.length) {
        c.innerHTML = '<div class="empty-state"><p>No defects</p></div>';
        return;
      }
      c.innerHTML = defects.map(d => `<div class="defect-item">
        <img src="${d.image}" class="defect-img" onclick="showImage('${d.image}')">
        <div class="defect-info">
          <div class="defect-number">Defect #${d.defectNumber} <span class="category-badge category-${d.category}">${CAT_LABELS[d.category]}</span></div>
          <div class="defect-meta">
            <div><strong>Building:</strong>${d.building}</div>
            <div><strong>Face:</strong>${d.face}</div>
            <div><strong>Drop:</strong>${d.drop}</div>
            <div><strong>Level:</strong>${d.level}</div>
            <div><strong>By:</strong>${d.addedBy}</div>
          </div>
          <div>${d.description}</div>
        </div>
        ${userRole==='manager'?`<button class="delete-btn" onclick="deleteDefect(${d.id})">üóëÔ∏è</button>`:''}
      </div>`).join('');
    }

    function showImage(s) {
      document.getElementById('modalImage').src = s;
      document.getElementById('imageModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('imageModal').classList.remove('active');
    }

    function updateUI() {
      const c = document.getElementById('defectCount'), n = document.getElementById('nextDefectNumber');
      if (c) c.textContent = defects.length;
      if (n) n.textContent = defects.length + 1;
    }

    function exitSession() {
      if (!confirm('Exit?')) return;
      if (defectsRef) defectsRef.off();
      if (configRef) configRef.off();
      document.getElementById('mainApp').classList.add('hidden');
      document.getElementById('setupScreen').classList.remove('hidden');
      projectId=''; userName=''; userRole=''; defects=[];
      defectsRef=null; configRef=null;
    }

    function loadManagerProjects() {
      document.getElementById('setupScreen').classList.add('hidden');
      document.getElementById('projectsScreen').classList.remove('hidden');
      db.ref('inspections').once('value').then(s => {
        const c = document.getElementById('projectsList');
        if (!s.exists()) {
          c.innerHTML = '<div class="empty-state"><p>No projects</p></div>';
          return;
        }
        const ps = [];
        s.forEach(ch => {
          const d = ch.val();
          ps.push({id:ch.key, name:d.config?.projectName||ch.key, by:d.config?.createdBy||'?', dc:d.defects?Object.keys(d.defects).length:0, nf:d.config?.numFaces||4});
        });
        c.innerHTML = ps.map(p => `<div class="project-item" onclick="selectProject('${p.id}')">
          <h4>${p.name}</h4><p>ID:${p.id}|By:${p.by}|Defects:${p.dc}|Faces:${p.nf}</p>
        </div>`).join('');
      });
    }

    function selectProject(p) {
      const n = document.getElementById('userName').value.trim() || prompt('Name:');
      if (!n) return;
      document.getElementById('userName').value = n;
      document.getElementById('projectId').value = p;
      document.getElementById('projectsScreen').classList.add('hidden');
      startSession('manager', true);
    }

    function showCreateProject() {
      document.getElementById('projectsScreen').classList.add('hidden');
      document.getElementById('createProjectScreen').classList.remove('hidden');
    }

    function createNewProject() {
      const p = document.getElementById('newProjectId').value.trim();
      const n = document.getElementById('newProjectName').value.trim();
      const nf = parseInt(document.getElementById('newProjectFaces').value);
      if (!p || !n) { alert('Fill all'); return; }
      const u = document.getElementById('userName').value.trim() || prompt('Name:');
      if (!u) return;
      document.getElementById('userName').value = u;
      document.getElementById('projectId').value = p;
      const sid = p.replace(/[.#$[\]]/g, '-');
      const faceNames = Array.from({length:nf}, (_,i) => `Face ${i+1}`);
      const faceConfigs = {};
      faceNames.forEach(fn => { faceConfigs[fn] = {maxDrops:15, maxLevels:10}; });
      const nc = {projectName:n, createdBy:u, numFaces:nf, faceNames:faceNames, faceConfigs:faceConfigs, facadePhotos:{}};
      db.ref(`inspections/${sid}/config`).set(nc).then(() => {
        document.getElementById('createProjectScreen').classList.add('hidden');
        startSession('manager', true);
      });
    }

    function backToProjects() {
      document.getElementById('createProjectScreen').classList.add('hidden');
      loadManagerProjects();
    }

    function backToSetup() {
      document.getElementById('projectsScreen').classList.add('hidden');
      document.getElementById('setupScreen').classList.remove('hidden');
    }

    // Stub export functions (implement full versions later)
    function exportWordDoc() { alert('Word export - add full implementation'); }
    function exportPDF() { alert('PDF export - add full implementation'); }
    function exportDefectMapsPDF() { alert('Maps export - add full implementation'); }

    debug('Script loaded successfully!');
  })();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>Building Inspector Pro</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      min-height: 100vh;
      background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
      color: #fff;
      font-family: 'Courier New', monospace;
      padding: 20px;
    }
    
    .header {
      background: linear-gradient(90deg, #f97316 0%, #ea580c 100%);
      padding: 24px;
      border-radius: 8px;
      margin-bottom: 24px;
      box-shadow: 0 4px 20px rgba(249, 115, 22, 0.3);
    }
    
    .header h1 {
      margin: 0;
      font-size: 28px;
      font-weight: bold;
      letter-spacing: -0.5px;
    }
    
    .header p {
      margin: 8px 0 0 0;
      opacity: 0.9;
      font-size: 14px;
    }

    .role-badge {
      display: inline-block;
      padding: 4px 12px;
      background: rgba(255,255,255,0.2);
      border-radius: 12px;
      font-size: 12px;
      margin-left: 12px;
    }
    
    .nav {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
      flex-wrap: wrap;
    }
    
    .nav-btn {
      padding: 12px 24px;
      background: #333;
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: bold;
      transition: all 0.2s;
      font-family: inherit;
    }
    
    .nav-btn.active {
      background: #f97316;
    }
    
    .nav-btn:hover:not(:disabled) {
      opacity: 0.9;
    }

    .nav-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
    }
    
    .card {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 24px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      margin-bottom: 16px;
    }
    
    .form-grid {
      display: grid;
      gap: 16px;
    }
    
    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-size: 12px;
      color: #999;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .form-control {
      width: 100%;
      padding: 12px;
      background: #1a1a1a;
      border: 2px solid #444;
      border-radius: 6px;
      color: #fff;
      font-size: 16px;
      font-family: inherit;
    }
    
    textarea.form-control {
      min-height: 100px;
      resize: vertical;
    }
    
    .btn {
      padding: 16px;
      background: linear-gradient(90deg, #f97316 0%, #ea580c 100%);
      border: none;
      border-radius: 6px;
      color: #fff;
      cursor: pointer;
      font-size: 16px;
      font-weight: bold;
      box-shadow: 0 4px 12px rgba(249, 115, 22, 0.3);
      transition: transform 0.2s;
      font-family: inherit;
      width: 100%;
    }
    
    .btn:active {
      transform: scale(0.98);
    }
    
    .btn-sm {
      padding: 12px 24px;
      font-size: 14px;
      width: auto;
    }
    
    .btn-green {
      background: #10b981;
    }
    
    .btn-blue {
      background: #3b82f6;
    }
    
    .btn-red {
      background: #ef4444;
    }

    .btn-purple {
      background: #8b5cf6;
    }
    
    .btn:disabled {
      background: #444;
      cursor: not-allowed;
      opacity: 0.6;
    }
    
    .defect-list {
      display: grid;
      gap: 12px;
    }
    
    .defect-item {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 16px;
      display: flex;
      gap: 16px;
      align-items: flex-start;
    }
    
    .defect-img {
      width: 120px;
      height: 120px;
      object-fit: cover;
      border-radius: 6px;
      cursor: pointer;
      border: 2px solid #444;
    }
    
    .defect-info {
      flex: 1;
    }
    
    .defect-number {
      font-size: 18px;
      font-weight: bold;
      color: #f97316;
      margin-bottom: 8px;
    }
    
    .defect-meta {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 8px;
      font-size: 13px;
      color: #999;
      margin-bottom: 8px;
    }
    
    .defect-desc {
      font-size: 14px;
      color: #ccc;
    }

    .category-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: bold;
      margin-top: 4px;
    }

    .category-crack { background: #ef4444; }
    .category-spalling { background: #f97316; }
    .category-water { background: #3b82f6; }
    .category-corrosion { background: #a855f7; }
    .category-other { background: #6b7280; }
    
    .delete-btn {
      padding: 8px;
      background: transparent;
      border: none;
      color: #ef4444;
      cursor: pointer;
      border-radius: 4px;
      font-size: 20px;
    }
    
    .delete-btn:hover {
      background: rgba(239, 68, 68, 0.1);
    }
    
    .empty-state {
      background: #2d2d2d;
      border-radius: 8px;
      padding: 48px;
      text-align: center;
      color: #666;
    }
    
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.95);
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }
    
    .modal.active {
      display: flex;
    }
    
    .modal img {
      max-width: 100%;
      max-height: 100%;
      border-radius: 8px;
    }
    
    .toolbar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .toolbar-right {
      margin-left: auto;
    }
    
    .hidden {
      display: none;
    }

    .setup-screen {
      max-width: 600px;
      margin: 50px auto;
    }

    .setup-screen h2 {
      color: #f97316;
      margin-bottom: 24px;
      font-size: 32px;
      text-align: center;
    }

    .setup-screen p {
      color: #999;
      margin-bottom: 32px;
      font-size: 16px;
      line-height: 1.6;
      text-align: center;
    }

    .role-cards {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
      margin-top: 32px;
    }

    .role-card {
      background: #2d2d2d;
      padding: 32px 24px;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s;
      border: 3px solid transparent;
      width: 100%;
      text-align: left;
      font-family: inherit;
      color: inherit;
      -webkit-tap-highlight-color: rgba(249, 115, 22, 0.3);
    }

    .role-card:hover, .role-card:active {
      border-color: #f97316;
      transform: translateY(-4px);
    }

    .role-card h3 {
      font-size: 24px;
      margin-bottom: 12px;
      color: #f97316;
      pointer-events: none;
    }

    .role-card ul {
      text-align: left;
      color: #999;
      font-size: 14px;
      line-height: 1.8;
      list-style-position: inside;
      pointer-events: none;
    }

    .sync-indicator {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 6px 12px;
      background: rgba(16, 185, 129, 0.2);
      border-radius: 12px;
      font-size: 12px;
      color: #10b981;
    }

    .sync-indicator.syncing {
      background: rgba(59, 130, 246, 0.2);
      color: #3b82f6;
    }

    .sync-indicator.offline {
      background: rgba(239, 68, 68, 0.2);
      color: #ef4444;
    }

    .sync-dot {
      width: 8px;
      height: 8px;
      background: currentColor;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .info-box {
      background: rgba(59, 130, 246, 0.1);
      border: 2px solid rgba(59, 130, 246, 0.3);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 24px;
      color: #93c5fd;
      font-size: 14px;
      line-height: 1.6;
    }

    .loading {
      text-align: center;
      padding: 48px;
      color: #999;
    }

    .spinner {
      border: 3px solid #333;
      border-top-color: #f97316;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Live Map Preview */
    .map-preview {
      background: #1a1a1a;
      border-radius: 8px;
      padding: 16px;
      margin-top: 16px;
      position: relative;
      overflow: hidden;
    }

    .map-canvas-container {
      position: relative;
      width: 100%;
      max-width: 800px;
      margin: 0 auto;
      background: #000;
      border-radius: 4px;
      overflow: hidden;
    }

    .map-canvas {
      display: block;
      width: 100%;
      height: auto;
    }

    .facade-photo-upload {
      margin-bottom: 16px;
      padding: 16px;
      background: rgba(249, 115, 22, 0.1);
      border: 2px dashed #f97316;
      border-radius: 8px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      width: 100%;
      font-family: inherit;
      color: inherit;
      -webkit-tap-highlight-color: rgba(249, 115, 22, 0.3);
    }

    .facade-photo-upload:hover, .facade-photo-upload:active {
      background: rgba(249, 115, 22, 0.2);
    }

    .facade-photo-upload.has-photo {
      border-style: solid;
      background: rgba(16, 185, 129, 0.1);
      border-color: #10b981;
    }

    .facade-photo-upload p {
      pointer-events: none;
    }

    .grid-controls {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-top: 12px;
      flex-wrap: wrap;
    }

    .grid-controls button {
      padding: 8px 16px;
      background: #333;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-size: 12px;
      font-family: inherit;
    }

    .grid-controls button:hover {
      background: #444;
    }
    
    @media (max-width: 768px) {
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .defect-item {
        flex-direction: column;
      }
      
      .defect-img {
        width: 100%;
        height: 200px;
      }

      .role-cards {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Setup Screen -->
  <div id="setupScreen" class="setup-screen">
    <div class="card">
      <h2>üèóÔ∏è Building Inspector Pro</h2>
      <p>Cloud-synced collaboration with live defect mapping</p>

      <div class="form-group" style="margin-bottom: 24px;">
        <label>Your Name</label>
        <input type="text" id="userName" class="form-control" placeholder="Enter your name (e.g., John Smith)">
      </div>
      
      <div class="form-group" style="margin-bottom: 24px;">
        <label>Project/Inspection ID</label>
        <input type="text" id="projectId" class="form-control" placeholder="Enter project ID">
        <p style="color: #666; font-size: 12px; margin-top: 8px;" id="projectHelp">
          All team members must use the same Project ID
        </p>
      </div>

      <div class="role-cards">
        <button class="role-card" onclick="startSession('worker')" type="button">
          <h3>ü™Ç Worker</h3>
          <ul>
            <li>Log defects</li>
            <li>Capture photos</li>
            <li>View live map</li>
            <li>Add categories</li>
          </ul>
        </button>

        <button class="role-card" onclick="startSession('manager')" type="button">
          <h3>üëî Manager</h3>
          <ul>
            <li>All worker features</li>
            <li>Create projects</li>
            <li>Configure settings</li>
            <li>Export reports</li>
            <li>Delete defects</li>
          </ul>
        </button>
      </div>
    </div>

    <!-- Firebase Setup Instructions -->
    <div class="card" style="margin-top: 24px; text-align: left;">
      <h3 style="color: #f97316; margin-bottom: 16px;">üîß Firebase Already Configured!</h3>
      <p style="color: #10b981;">‚úÖ Your Firebase database is ready to use. Just enter a project ID and start logging defects!</p>
    </div>
  </div>

  <!-- Loading Screen -->
  <div id="loadingScreen" class="loading hidden">
    <div class="spinner"></div>
    <p>Connecting to database...</p>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden">
    <div class="header">
      <div style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
        <div>
          <h1>
            Building Inspector Pro
            <span class="role-badge" id="roleBadge"></span>
          </h1>
          <p>
            <span id="userNameDisplay"></span> ‚Ä¢ 
            Project: <span id="projectName"></span> ‚Ä¢ 
            Defects: <span id="defectCount">0</span> ‚Ä¢ 
            <span id="syncIndicator" class="sync-indicator">
              <span class="sync-dot"></span>
              <span id="syncText">Connected</span>
            </span>
          </p>
        </div>
        <button class="btn btn-sm btn-red" onclick="exitSession()">Exit</button>
      </div>
    </div>

    <div class="nav">
      <button class="nav-btn active" onclick="showView('entry')">üì∏ Log Defect</button>
      <button class="nav-btn" onclick="showView('list')">üìã View All</button>
      <button class="nav-btn" onclick="showView('liveMap')">üó∫Ô∏è Live Map</button>
      <button class="nav-btn" id="configBtn" onclick="showView('config')" style="display: none;">‚öôÔ∏è Settings</button>
    </div>

    <!-- Entry View -->
    <div id="entryView">
      <div class="card">
        <h2 style="margin: 0 0 24px 0; font-size: 20px; color: #f97316;">
          Defect #<span id="nextDefectNumber">1</span>
        </h2>

        <div class="form-grid">
          <div class="form-row">
            <div class="form-group">
              <label>Building</label>
              <input type="text" id="building" class="form-control" value="1">
            </div>
            <div class="form-group">
              <label>Face</label>
              <select id="face" class="form-control">
                <option>North</option>
                <option>South</option>
                <option>East</option>
                <option>West</option>
              </select>
            </div>
          </div>

          <div class="form-row">
            <div class="form-group">
              <label>Drop</label>
              <input type="text" id="drop" class="form-control" value="1">
            </div>
            <div class="form-group">
              <label>Level</label>
              <input type="text" id="level" class="form-control" value="1">
            </div>
          </div>

          <div class="form-group">
            <label>Category</label>
            <select id="category" class="form-control">
              <option value="crack">Crack</option>
              <option value="spalling">Spalling</option>
              <option value="water">Water Damage</option>
              <option value="corrosion">Corrosion</option>
              <option value="other">Other</option>
            </select>
          </div>

          <div class="form-group">
            <label>Description</label>
            <textarea id="description" class="form-control" placeholder="Describe the defect..."></textarea>
          </div>

          <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;">
          <button class="btn" onclick="document.getElementById('photoInput').click()">
            üì∑ Capture Photo & Log Defect
          </button>
        </div>
      </div>
    </div>

    <!-- List View -->
    <div id="listView" class="hidden">
      <div class="card toolbar" id="managerToolbar" style="display: none;">
        <button class="btn btn-sm btn-green" onclick="exportWordDoc()">
          ‚¨áÔ∏è Word Report
        </button>
        <button class="btn btn-sm btn-blue" onclick="exportPDF()">
          üìÑ PDF Report
        </button>
        <button class="btn btn-sm btn-purple" onclick="exportDefectMaps()">
          üìç Defect Maps
        </button>
        <button class="btn btn-sm btn-red toolbar-right" onclick="clearAllData()">
          üóëÔ∏è Clear All
        </button>
      </div>

      <div id="defectListContainer"></div>
    </div>

    <!-- Live Map View -->
    <div id="liveMapView" class="hidden">
      <div class="card">
        <h2 style="margin: 0 0 16px 0; color: #f97316;">Live Defect Map</h2>
        
        <div class="form-group" style="margin-bottom: 16px;">
          <label>Select Face to View</label>
          <select id="mapFaceSelect" class="form-control" onchange="renderLiveMap()">
            <option>North</option>
            <option>South</option>
            <option>East</option>
            <option>West</option>
          </select>
        </div>

        <button class="facade-photo-upload" id="facadeUploadZone" onclick="document.getElementById('facadePhotoInput').click()" type="button">
          <p style="margin: 0; color: #f97316; font-weight: bold;">üì∏ Click to Upload Facade Photo (Optional)</p>
          <p style="margin: 8px 0 0 0; font-size: 12px; color: #999;">Adds building photo behind the grid for precise defect mapping</p>
        </button>
        <input type="file" id="facadePhotoInput" accept="image/*" style="display: none;">

        <div class="map-preview">
          <div class="map-canvas-container">
            <canvas id="liveMapCanvas" class="map-canvas"></canvas>
          </div>
          <div class="grid-controls" id="gridControls" style="display: none;">
            <button onclick="adjustGrid('left')">‚Üê Left</button>
            <button onclick="adjustGrid('right')">Right ‚Üí</button>
            <button onclick="adjustGrid('up')">‚Üë Up</button>
            <button onclick="adjustGrid('down')">‚Üì Down</button>
            <button onclick="adjustGrid('wider')">‚¨å Wider</button>
            <button onclick="adjustGrid('narrower')">‚¨ç Narrower</button>
            <button onclick="adjustGrid('taller')">‚¨ç Taller</button>
            <button onclick="adjustGrid('shorter')">‚¨å Shorter</button>
            <button onclick="resetGrid()" style="background: #ef4444;">‚Ü∫ Reset</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Config View (Manager Only) -->
    <div id="configView" class="hidden">
      <div class="card">
        <h2 style="margin: 0 0 24px 0; font-size: 20px; color: #f97316;">‚öôÔ∏è Project Settings</h2>
        
        <div class="form-grid">
          <h3 style="color: #999; font-size: 14px; margin-bottom: -8px;">GRID CONFIGURATION</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Max Drops per Face</label>
              <input type="number" id="maxDrops" class="form-control" value="15" min="1" max="50">
            </div>
            <div class="form-group">
              <label>Max Levels per Face</label>
              <input type="number" id="maxLevels" class="form-control" value="10" min="1" max="50">
            </div>
          </div>

          <div class="form-group">
            <label>Project Name</label>
            <input type="text" id="projectNameInput" class="form-control" placeholder="e.g., Harbor Tower Inspection">
          </div>

          <button class="btn btn-purple" onclick="saveConfig()">
            üíæ Save Configuration
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Image Modal -->
  <div id="imageModal" class="modal" onclick="closeModal()">
    <img id="modalImage" src="" alt="Defect full view">
  </div>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
  <!-- jsPDF for PDF export -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <script>
    // Firebase Configuration
    const firebaseConfig = {
      apiKey: "AIzaSyDork6Cl33rHNPKU88sFYVcOkKW_Wj68BY",
      authDomain: "building-inspector-79c34.firebaseapp.com",
      databaseURL: "https://building-inspector-79c34-default-rtdb.asia-southeast1.firebasedatabase.app/",
      projectId: "building-inspector-79c34",
      storageBucket: "building-inspector-79c34.firebasestorage.app",
      messagingSenderId: "73507039597",
      appId: "1:73507039597:web:1c043682b0d58a6e549264"
    };

    // Initialize Firebase
    let db;
    try {
      firebase.initializeApp(firebaseConfig);
      db = firebase.database();
    } catch (error) {
      console.error("Firebase initialization error:", error);
    }

    // Application State
    let projectId = '';
    let userName = '';
    let userRole = '';
    let defects = [];
    let config = {
      maxDrops: 15,
      maxLevels: 10,
      projectName: '',
      createdBy: '',
      facadePhotos: {} // Store facade photos per face
    };
    let currentView = 'entry';
    let defectsRef = null;
    let configRef = null;
    let facadePhoto = null;
    let gridAdjustments = {
      offsetX: 0,
      offsetY: 0,
      scaleX: 1,
      scaleY: 1
    };

    // Add touch event support for iOS
    document.addEventListener('DOMContentLoaded', function() {
      // Make all buttons work better on iOS
      document.querySelectorAll('button, .role-card').forEach(function(el) {
        el.addEventListener('touchstart', function() {}, {passive: true});
      });
    });

    // Session Management
    function startSession(role) {
      const inputUserName = document.getElementById('userName').value.trim();
      const inputProjectId = document.getElementById('projectId').value.trim();
      
      if (!inputUserName) {
        alert('Please enter your name');
        return;
      }

      if (!inputProjectId) {
        alert('Please enter a Project ID');
        return;
      }

      if (!db) {
        alert('Firebase not configured. Please check setup.');
        return;
      }

      projectId = inputProjectId.replace(/[.#$[\]]/g, '-');
      userName = inputUserName;
      userRole = role;

      document.getElementById('setupScreen').classList.add('hidden');
      document.getElementById('loadingScreen').classList.remove('hidden');

      defectsRef = db.ref(`inspections/${projectId}/defects`);
      configRef = db.ref(`inspections/${projectId}/config`);

      // Check if project exists
      configRef.once('value').then((configSnapshot) => {
        if (configSnapshot.exists()) {
          // Project exists - load it
          config = configSnapshot.val();
          
          // For workers, verify project exists
          if (role === 'worker') {
            loadExistingProject();
          } else {
            loadExistingProject();
          }
        } else {
          // Project doesn't exist
          if (role === 'manager') {
            // Manager creates new project
            config.createdBy = userName;
            config.projectName = projectId;
            configRef.set(config).then(() => {
              loadExistingProject();
            });
          } else {
            // Worker cannot create project
            alert('This project does not exist. Please ask a manager to create it first, or enter an existing project ID.');
            document.getElementById('loadingScreen').classList.add('hidden');
            document.getElementById('setupScreen').classList.remove('hidden');
          }
        }
      }).catch(error => {
        console.error('Error checking project:', error);
        alert('Error connecting to database. Please try again.');
        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('setupScreen').classList.remove('hidden');
      });
    }

    function loadExistingProject() {
      Promise.all([
        defectsRef.once('value')
      ]).then(([defectsSnapshot]) => {
        if (defectsSnapshot.exists()) {
          const defectsObj = defectsSnapshot.val();
          defects = Object.values(defectsObj);
        }

        setupRealtimeListeners();

        document.getElementById('loadingScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        document.getElementById('roleBadge').textContent = userRole.toUpperCase();
        document.getElementById('projectName').textContent = projectId;
        document.getElementById('userNameDisplay').textContent = userName;

        if (userRole === 'manager') {
          document.getElementById('configBtn').style.display = 'block';
          document.getElementById('managerToolbar').style.display = 'flex';
        }

        // Load facade photo for current face if exists
        loadFacadePhoto();

        updateUI();
        setSyncIndicator('connected');
      });
    }

    function exitSession() {
      if (confirm('Exit this inspection session?')) {
        if (defectsRef) defectsRef.off();
        if (configRef) configRef.off();

        document.getElementById('mainApp').classList.add('hidden');
        document.getElementById('setupScreen').classList.remove('hidden');
        projectId = '';
        userName = '';
        userRole = '';
        defects = [];
        defectsRef = null;
        configRef = null;
      }
    }

    // Real-time Sync
    function setupRealtimeListeners() {
      defectsRef.on('value', (snapshot) => {
        if (snapshot.exists()) {
          const defectsObj = snapshot.val();
          defects = Object.values(defectsObj);
        } else {
          defects = [];
        }
        updateUI();
        if (currentView === 'list') {
          renderDefectList();
        }
        if (currentView === 'liveMap') {
          renderLiveMap();
        }
        setSyncIndicator('connected');
      });

      configRef.on('value', (snapshot) => {
        if (snapshot.exists()) {
          config = snapshot.val();
          document.getElementById('maxDrops').value = config.maxDrops;
          document.getElementById('maxLevels').value = config.maxLevels;
          document.getElementById('projectNameInput').value = config.projectName || '';
          
          // Reload facade photo if it changed
          loadFacadePhoto();
          if (currentView === 'liveMap') {
            renderLiveMap();
          }
        }
      });

      const connectedRef = db.ref('.info/connected');
      connectedRef.on('value', (snap) => {
        if (snap.val() === true) {
          setSyncIndicator('connected');
        } else {
          setSyncIndicator('offline');
        }
      });
    }

    function setSyncIndicator(state) {
      const indicator = document.getElementById('syncIndicator');
      const text = document.getElementById('syncText');
      
      indicator.classList.remove('syncing', 'offline');
      
      if (state === 'syncing') {
        indicator.classList.add('syncing');
        text.textContent = 'Syncing...';
      } else if (state === 'offline') {
        indicator.classList.add('offline');
        text.textContent = 'Offline';
      } else {
        text.textContent = 'Connected';
      }
    }

    // Defect Management
    document.getElementById('photoInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        if (file.size > 5 * 1024 * 1024) {
          alert('Image too large. Please use a smaller image (under 5MB)');
          e.target.value = '';
          return;
        }

        setSyncIndicator('syncing');
        
        const reader = new FileReader();
        reader.onloadend = function() {
          const newDefect = {
            id: Date.now(),
            building: document.getElementById('building').value,
            face: document.getElementById('face').value,
            drop: document.getElementById('drop').value,
            level: document.getElementById('level').value,
            category: document.getElementById('category').value,
            defectNumber: defects.length + 1,
            description: document.getElementById('description').value || 'No description provided',
            image: reader.result,
            timestamp: new Date().toISOString(),
            addedBy: userName
          };

          defectsRef.child(newDefect.id.toString()).set(newDefect).then(() => {
            document.getElementById('description').value = '';
            e.target.value = '';
            alert(`‚úÖ Defect #${newDefect.defectNumber} logged by ${userName}!`);
          }).catch(error => {
            console.error('Error saving defect:', error);
            alert('Error saving defect. Please try again.');
            setSyncIndicator('offline');
          });
        };
        reader.readAsDataURL(file);
      }
    });

    function deleteDefect(id) {
      if (userRole !== 'manager') return;
      
      if (confirm('Delete this defect? This will affect all team members.')) {
        setSyncIndicator('syncing');
        
        defectsRef.child(id.toString()).remove().then(() => {
          const remaining = defects.filter(d => d.id !== id);
          const updates = {};
          
          remaining.forEach((d, idx) => {
            d.defectNumber = idx + 1;
            updates[d.id] = d;
          });

          defectsRef.set(updates).then(() => {
            renderDefectList();
          });
        }).catch(error => {
          console.error('Error deleting defect:', error);
          alert('Error deleting defect. Please try again.');
        });
      }
    }

    function clearAllData() {
      if (userRole !== 'manager') return;
      
      if (confirm(`Delete all ${defects.length} defects? This affects the entire team and cannot be undone.`)) {
        setSyncIndicator('syncing');
        defectsRef.remove().then(() => {
          alert('All defects cleared.');
        }).catch(error => {
          console.error('Error clearing defects:', error);
          alert('Error clearing data. Please try again.');
        });
      }
    }

    // Config Management
    function saveConfig() {
      if (userRole !== 'manager') return;

      config.maxDrops = parseInt(document.getElementById('maxDrops').value);
      config.maxLevels = parseInt(document.getElementById('maxLevels').value);
      config.projectName = document.getElementById('projectNameInput').value;

      setSyncIndicator('syncing');
      configRef.set(config).then(() => {
        alert('Configuration saved! All team members will see the update.');
      }).catch(error => {
        console.error('Error saving config:', error);
        alert('Error saving configuration. Please try again.');
      });
    }

    // Facade Photo Management
    document.getElementById('facadePhotoInput').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onloadend = function() {
          const currentFace = document.getElementById('mapFaceSelect').value;
          
          // Save to config
          if (!config.facadePhotos) config.facadePhotos = {};
          config.facadePhotos[currentFace] = reader.result;
          
          if (userRole === 'manager') {
            configRef.update({ facadePhotos: config.facadePhotos }).then(() => {
              facadePhoto = reader.result;
              document.getElementById('facadeUploadZone').classList.add('has-photo');
              document.getElementById('gridControls').style.display = 'flex';
              renderLiveMap();
            });
          } else {
            facadePhoto = reader.result;
            document.getElementById('facadeUploadZone').classList.add('has-photo');
            document.getElementById('gridControls').style.display = 'flex';
            renderLiveMap();
          }
        };
        reader.readAsDataURL(file);
      }
    });

    function loadFacadePhoto() {
      const currentFace = document.getElementById('mapFaceSelect').value;
      if (config.facadePhotos && config.facadePhotos[currentFace]) {
        facadePhoto = config.facadePhotos[currentFace];
        document.getElementById('facadeUploadZone').classList.add('has-photo');
        document.getElementById('gridControls').style.display = 'flex';
      } else {
        facadePhoto = null;
        document.getElementById('facadeUploadZone').classList.remove('has-photo');
        document.getElementById('gridControls').style.display = 'none';
      }
    }

    // Grid Adjustment Functions
    function adjustGrid(direction) {
      const step = 10;
      switch(direction) {
        case 'left': gridAdjustments.offsetX -= step; break;
        case 'right': gridAdjustments.offsetX += step; break;
        case 'up': gridAdjustments.offsetY -= step; break;
        case 'down': gridAdjustments.offsetY += step; break;
        case 'wider': gridAdjustments.scaleX += 0.05; break;
        case 'narrower': gridAdjustments.scaleX -= 0.05; break;
        case 'taller': gridAdjustments.scaleY += 0.05; break;
        case 'shorter': gridAdjustments.scaleY -= 0.05; break;
      }
      renderLiveMap();
    }

    function resetGrid() {
      gridAdjustments = { offsetX: 0, offsetY: 0, scaleX: 1, scaleY: 1 };
      renderLiveMap();
    }

    // Live Map Rendering
    function renderLiveMap() {
      const canvas = document.getElementById('liveMapCanvas');
      const ctx = canvas.getContext('2d');
      const currentFace = document.getElementById('mapFaceSelect').value;
      
      const canvasWidth = 800;
      const canvasHeight = 600;
      canvas.width = canvasWidth;
      canvas.height = canvasHeight;
      
      const margin = 40;
      const gridWidth = (canvasWidth - margin * 2) * gridAdjustments.scaleX;
      const gridHeight = (canvasHeight - margin * 2) * gridAdjustments.scaleY;
      const gridStartX = margin + gridAdjustments.offsetX;
      const gridStartY = margin + gridAdjustments.offsetY;
      
      // Background
      ctx.fillStyle = '#1a1a1a';
      ctx.fillRect(0, 0, canvasWidth, canvasHeight);
      
      // Draw facade photo if exists
      if (facadePhoto) {
        const img = new Image();
        img.onload = function() {
          ctx.drawImage(img, 0, 0, canvasWidth, canvasHeight);
          drawGrid();
        };
        img.src = facadePhoto;
      } else {
        drawGrid();
      }
      
      function drawGrid() {
        const cellWidth = gridWidth / config.maxDrops;
        const cellHeight = gridHeight / config.maxLevels;
        
        // Grid outline
        ctx.strokeStyle = facadePhoto ? '#f97316' : '#444';
        ctx.lineWidth = 3;
        ctx.strokeRect(gridStartX, gridStartY, gridWidth, gridHeight);
        
        // Grid lines
        ctx.strokeStyle = facadePhoto ? 'rgba(249, 115, 22, 0.5)' : '#333';
        ctx.lineWidth = 1;
        
        for (let i = 1; i < config.maxLevels; i++) {
          const y = gridStartY + (i * cellHeight);
          ctx.beginPath();
          ctx.moveTo(gridStartX, y);
          ctx.lineTo(gridStartX + gridWidth, y);
          ctx.stroke();
        }
        
        for (let i = 1; i < config.maxDrops; i++) {
          const x = gridStartX + (i * cellWidth);
          ctx.beginPath();
          ctx.moveTo(x, gridStartY);
          ctx.lineTo(x, gridStartY + gridHeight);
          ctx.stroke();
        }
        
        // Labels
        ctx.fillStyle = facadePhoto ? '#fff' : '#666';
        ctx.font = '12px Arial';
        ctx.textAlign = 'right';
        
        // Level labels (reversed - level 1 at bottom)
        for (let i = 0; i < config.maxLevels; i++) {
          const displayLevel = config.maxLevels - i;
          const y = gridStartY + (i * cellHeight) + (cellHeight / 2) + 4;
          ctx.fillText(displayLevel.toString(), gridStartX - 5, y);
        }
        
        // Drop labels
        ctx.textAlign = 'center';
        for (let i = 0; i < config.maxDrops; i++) {
          const x = gridStartX + (i * cellWidth) + (cellWidth / 2);
          ctx.fillText((i + 1).toString(), x, gridStartY - 5);
        }
        
        // Plot defects
        const faceDefects = defects.filter(d => d.face === currentFace);
        const defectsByLocation = {};
        
        faceDefects.forEach(d => {
          const key = `${d.drop}-${d.level}`;
          if (!defectsByLocation[key]) defectsByLocation[key] = [];
          defectsByLocation[key].push(d);
        });
        
        Object.entries(defectsByLocation).forEach(([key, locationDefects]) => {
          const [drop, level] = key.split('-').map(Number);
          
          if (drop > config.maxDrops || level > config.maxLevels) return;
          
          const baseX = gridStartX + ((drop - 1) * cellWidth);
          const baseY = gridStartY + ((config.maxLevels - level) * cellHeight);
          const count = locationDefects.length;
          const markerSize = Math.min(15, cellWidth / (count + 1));
          
          locationDefects.forEach((d, idx) => {
            let x, y;
            
            if (count === 1) {
              x = baseX + (cellWidth / 2);
              y = baseY + (cellHeight / 2);
            } else if (count === 2) {
              x = baseX + (cellWidth / 3) * (idx + 1);
              y = baseY + (cellHeight / 2);
            } else {
              const perRow = Math.ceil(Math.sqrt(count));
              const col = idx % perRow;
              const row = Math.floor(idx / perRow);
              x = baseX + (cellWidth / (perRow + 1)) * (col + 1);
              y = baseY + (cellHeight / (Math.ceil(count / perRow) + 1)) * (row + 1);
            }
            
            // Draw marker with category color
            const colors = {
              crack: '#ef4444',
              spalling: '#f97316',
              water: '#3b82f6',
              corrosion: '#a855f7',
              other: '#6b7280'
            };
            
            ctx.fillStyle = colors[d.category] || '#f97316';
            ctx.beginPath();
            ctx.arc(x, y, markerSize, 0, Math.PI * 2);
            ctx.fill();
            
            // White border
            ctx.strokeStyle = '#fff';
            ctx.lineWidth = 2;
            ctx.stroke();
            
            // Defect number
            ctx.fillStyle = '#fff';
            ctx.font = `bold ${Math.max(10, markerSize * 0.8)}px Arial`;
            ctx.textAlign = 'center';
            ctx.fillText(d.defectNumber.toString(), x, y + (markerSize / 3));
          });
        });
        
        // Legend
        ctx.textAlign = 'left';
        ctx.fillStyle = facadePhoto ? '#fff' : '#999';
        ctx.font = '11px Arial';
        let legendY = canvasHeight - 50;
        ctx.fillText(`${currentFace} Face - ${faceDefects.length} defects`, 10, legendY);
        
        // Category legend
        const legendItems = [
          { label: 'Crack', color: '#ef4444' },
          { label: 'Spalling', color: '#f97316' },
          { label: 'Water', color: '#3b82f6' },
          { label: 'Corrosion', color: '#a855f7' },
          { label: 'Other', color: '#6b7280' }
        ];
        
        let legendX = 10;
        legendY += 15;
        legendItems.forEach(item => {
          ctx.fillStyle = item.color;
          ctx.beginPath();
          ctx.arc(legendX + 5, legendY, 5, 0, Math.PI * 2);
          ctx.fill();
          
          ctx.fillStyle = facadePhoto ? '#fff' : '#999';
          ctx.fillText(item.label, legendX + 15, legendY + 4);
          legendX += 90;
        });
      }
    }

    // UI Management
    function showView(view) {
      currentView = view;
      document.getElementById('entryView').classList.toggle('hidden', view !== 'entry');
      document.getElementById('listView').classList.toggle('hidden', view !== 'list');
      document.getElementById('liveMapView').classList.toggle('hidden', view !== 'liveMap');
      document.getElementById('configView').classList.toggle('hidden', view !== 'config');
      
      document.querySelectorAll('.nav-btn').forEach(btn => btn.classList.remove('active'));
      
      if (view === 'entry') document.querySelector('.nav-btn:nth-child(1)').classList.add('active');
      if (view === 'list') {
        document.querySelector('.nav-btn:nth-child(2)').classList.add('active');
        renderDefectList();
      }
      if (view === 'liveMap') {
        document.querySelector('.nav-btn:nth-child(3)').classList.add('active');
        loadFacadePhoto();
        renderLiveMap();
      }
      if (view === 'config') document.getElementById('configBtn').classList.add('active');
    }

    function renderDefectList() {
      const container = document.getElementById('defectListContainer');
      
      if (defects.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div style="font-size: 48px; margin-bottom: 16px; opacity: 0.5;">üìã</div>
            <p>No defects logged yet. Start by capturing some photos!</p>
          </div>
        `;
      } else {
        const categoryLabels = {
          crack: 'Crack',
          spalling: 'Spalling',
          water: 'Water Damage',
          corrosion: 'Corrosion',
          other: 'Other'
        };
        
        container.innerHTML = defects.map(d => `
          <div class="defect-item">
            <img src="${d.image}" alt="Defect ${d.defectNumber}" class="defect-img" onclick="showImage('${d.image}')">
            <div class="defect-info">
              <div class="defect-number">
                Defect #${d.defectNumber}
                <span class="category-badge category-${d.category}">${categoryLabels[d.category] || d.category}</span>
              </div>
              <div class="defect-meta">
                <div><strong>Building:</strong> ${d.building}</div>
                <div><strong>Face:</strong> ${d.face}</div>
                <div><strong>Drop:</strong> ${d.drop}</div>
                <div><strong>Level:</strong> ${d.level}</div>
                <div><strong>Logged by:</strong> ${d.addedBy}</div>
              </div>
              <div class="defect-desc">${d.description}</div>
            </div>
            ${userRole === 'manager' ? `<button class="delete-btn" onclick="deleteDefect(${d.id})">üóëÔ∏è</button>` : ''}
          </div>
        `).join('');
      }
    }

    function showImage(src) {
      document.getElementById('modalImage').src = src;
      document.getElementById('imageModal').classList.add('active');
    }

    function closeModal() {
      document.getElementById('imageModal').classList.remove('active');
    }

    function updateUI() {
      document.getElementById('defectCount').textContent = defects.length;
      document.getElementById('nextDefectNumber').textContent = defects.length + 1;
    }

    // Export Functions
    function exportWordDoc() {
      if (userRole !== 'manager') {
        alert('Only managers can export reports.');
        return;
      }

      if (defects.length === 0) {
        alert('No defects to export yet!');
        return;
      }

      const categoryLabels = {
        crack: 'Crack',
        spalling: 'Spalling',
        water: 'Water Damage',
        corrosion: 'Corrosion',
        other: 'Other'
      };

      try {
        let html = `
          <html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word'>
          <head>
            <meta charset='utf-8'>
            <title>Defect Report</title>
            <style>
              body { font-family: Arial, sans-serif; }
              table { border-collapse: collapse; width: 100%; margin-top: 20px; }
              th, td { border: 1px solid #000; padding: 10px; vertical-align: top; }
              th { background-color: #f97316; color: white; font-weight: bold; }
              h1 { color: #1a1a1a; margin-bottom: 20px; }
              .info { color: #666; margin: 5px 0; }
              .defect-img { max-width: 250px; max-height: 250px; display: block; }
            </style>
          </head>
          <body>
            <h1>Building Inspection Defect Report</h1>
            <p class="info"><strong>Project:</strong> ${config.projectName || projectId}</p>
            <p class="info"><strong>Generated:</strong> ${new Date().toLocaleString()}</p>
            <p class="info"><strong>Total Defects:</strong> ${defects.length}</p>
            
            <table>
              <thead>
                <tr>
                  <th>Defect #</th>
                  <th>Building</th>
                  <th>Face</th>
                  <th>Drop</th>
                  <th>Level</th>
                  <th>Category</th>
                  <th>Description</th>
                  <th>Logged By</th>
                  <th>Photo</th>
                </tr>
              </thead>
              <tbody>
        `;
        
        defects.forEach((d) => {
          html += `
            <tr>
              <td style='text-align: center;'><strong>${d.defectNumber}</strong></td>
              <td style='text-align: center;'>${d.building}</td>
              <td style='text-align: center;'>${d.face}</td>
              <td style='text-align: center;'>${d.drop}</td>
              <td style='text-align: center;'>${d.level}</td>
              <td style='text-align: center;'>${categoryLabels[d.category] || d.category}</td>
              <td>${d.description}</td>
              <td style='text-align: center;'>${d.addedBy}</td>
              <td style='text-align: center;'>
                <img src="${d.image}" class="defect-img" alt="Defect ${d.defectNumber} photo"/>
              </td>
            </tr>
          `;
        });
        
        html += `
              </tbody>
            </table>
            <p style="margin-top: 30px; color: #666; font-size: 12px;">
              <em>Report generated by Building Inspector Pro on ${new Date().toLocaleDateString()}</em>
            </p>
          </body>
          </html>
        `;
        
        const blob = new Blob(['\ufeff', html], { 
          type: 'application/msword;charset=utf-8' 
        });
        
        const url = URL.createObjectURL(blob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `Defect-Report-${projectId}-${new Date().toISOString().split('T')[0]}.doc`;
        
        document.body.appendChild(link);
        link.click();
        
        setTimeout(() => {
          document.body.removeChild(link);
          URL.revokeObjectURL(url);
        }, 100);
        
        alert('‚úÖ Word report downloaded!');
        
      } catch (error) {
        console.error('Export error:', error);
        alert('‚ùå Error creating report: ' + error.message);
      }
    }

    function exportPDF() {
      if (userRole !== 'manager') {
        alert('Only managers can export reports.');
        return;
      }

      if (defects.length === 0) {
        alert('No defects to export yet!');
        return;
      }

      try {
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        // Title
        doc.setFontSize(20);
        doc.setTextColor(249, 115, 22);
        doc.text('Building Inspection Defect Report', 20, 20);
        
        // Info
        doc.setFontSize(12);
        doc.setTextColor(100);
        doc.text(`Project: ${config.projectName || projectId}`, 20, 35);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 20, 42);
        doc.text(`Total Defects: ${defects.length}`, 20, 49);
        
        let yPos = 60;
        
        const categoryLabels = {
          crack: 'Crack',
          spalling: 'Spalling',
          water: 'Water Damage',
          corrosion: 'Corrosion',
          other: 'Other'
        };
        
        defects.forEach((d, idx) => {
          if (yPos > 250) {
            doc.addPage();
            yPos = 20;
          }
          
          doc.setFontSize(14);
          doc.setTextColor(0);
          doc.text(`Defect #${d.defectNumber}`, 20, yPos);
          
          doc.setFontSize(10);
          doc.setTextColor(100);
          yPos += 7;
          doc.text(`Building: ${d.building} | Face: ${d.face} | Drop: ${d.drop} | Level: ${d.level}`, 20, yPos);
          yPos += 7;
          doc.text(`Category: ${categoryLabels[d.category]} | Logged by: ${d.addedBy}`, 20, yPos);
          yPos += 7;
          doc.text(`Description: ${d.description}`, 20, yPos, { maxWidth: 170 });
          
          yPos += 15;
          
          // Add image
          if (d.image) {
            try {
              doc.addImage(d.image, 'JPEG', 20, yPos, 60, 45);
              yPos += 50;
            } catch (e) {
              console.error('Error adding image:', e);
            }
          }
          
          yPos += 5;
        });
        
        doc.save(`Defect-Report-${projectId}-${new Date().toISOString().split('T')[0]}.pdf`);
        alert('‚úÖ PDF report downloaded!');
        
      } catch (error) {
        console.error('PDF export error:', error);
        alert('‚ùå Error creating PDF: ' + error.message);
      }
    }

    function exportDefectMaps() {
      if (userRole !== 'manager') return;

      if (defects.length === 0) {
        alert('No defects to map yet!');
        return;
      }

      const faces = ['North', 'South', 'East', 'West'];
      let downloadCount = 0;
      
      faces.forEach((face) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        canvas.width = 1200;
        canvas.height = 1600;
        
        const margin = 60;
        const gridWidth = canvas.width - (margin * 2);
        const gridHeight = canvas.height - 250;
        const cellWidth = gridWidth / config.maxDrops;
        const cellHeight = gridHeight / config.maxLevels;
        
        ctx.fillStyle = '#1a1a1a';
        ctx.fillRect(0, 0, canvas.width, canvas.height);
        
        // Check if there's a facade photo for this face
        if (config.facadePhotos && config.facadePhotos[face]) {
          const img = new Image();
          img.onload = function() {
            ctx.save();
            ctx.globalAlpha = 0.6;
            ctx.drawImage(img, margin, 180, gridWidth, gridHeight);
            ctx.restore();
            drawFaceMap();
          };
          img.src = config.facadePhotos[face];
        } else {
          drawFaceMap();
        }
        
        function drawFaceMap() {
          ctx.fillStyle = '#f97316';
          ctx.font = 'bold 36px Arial';
          ctx.fillText(`${face} Face - Defect Map`, margin, 60);
          
          ctx.fillStyle = '#999';
          ctx.font = '16px Arial';
          const faceDefects = defects.filter(d => d.face === face);
          ctx.fillText(`Project: ${config.projectName || projectId}`, margin, 95);
          ctx.fillText(`Defects: ${faceDefects.length}`, margin, 120);
          ctx.fillText(`Generated: ${new Date().toLocaleString()}`, margin, 145);
          
          const gridStartY = 180;
          
          ctx.strokeStyle = '#444';
          ctx.lineWidth = 3;
          ctx.strokeRect(margin, gridStartY, gridWidth, gridHeight);
          
          ctx.strokeStyle = '#333';
          ctx.lineWidth = 1;
          
          for (let i = 1; i < config.maxLevels; i++) {
            const y = gridStartY + (i * cellHeight);
            ctx.beginPath();
            ctx.moveTo(margin, y);
            ctx.lineTo(margin + gridWidth, y);
            ctx.stroke();
          }
          
          for (let i = 1; i < config.maxDrops; i++) {
            const x = margin + (i * cellWidth);
            ctx.beginPath();
            ctx.moveTo(x, gridStartY);
            ctx.lineTo(x, gridStartY + gridHeight);
            ctx.stroke();
          }
          
          ctx.fillStyle = '#666';
          ctx.font = '12px Arial';
          ctx.textAlign = 'right';
          
          for (let i = 0; i < config.maxLevels; i++) {
            const displayLevel = config.maxLevels - i;
            const y = gridStartY + (i * cellHeight) + (cellHeight / 2) + 4;
            ctx.fillText(displayLevel.toString(), margin - 10, y);
          }
          
          ctx.textAlign = 'center';
          for (let i = 0; i < config.maxDrops; i++) {
            const x = margin + (i * cellWidth) + (cellWidth / 2);
            ctx.fillText((i + 1).toString(), x, gridStartY - 10);
          }
          
          const defectsByLocation = {};
          faceDefects.forEach(d => {
            const key = `${d.drop}-${d.level}`;
            if (!defectsByLocation[key]) defectsByLocation[key] = [];
            defectsByLocation[key].push(d);
          });
          
          const categoryColors = {
            crack: '#ef4444',
            spalling: '#f97316',
            water: '#3b82f6',
            corrosion: '#a855f7',
            other: '#6b7280'
          };
          
          Object.entries(defectsByLocation).forEach(([key, locationDefects]) => {
            const [drop, level] = key.split('-').map(Number);
            
            if (drop > config.maxDrops || level > config.maxLevels) return;
            
            const baseX = margin + ((drop - 1) * cellWidth);
            const baseY = gridStartY + ((config.maxLevels - level) * cellHeight);
            const count = locationDefects.length;
            const markerSize = Math.min(12, cellWidth / (count + 1));
            
            locationDefects.forEach((d, idx) => {
              let x, y;
              
              if (count === 1) {
                x = baseX + (cellWidth / 2);
                y = baseY + (cellHeight / 2);
              } else if (count === 2) {
                x = baseX + (cellWidth / 3) * (idx + 1);
                y = baseY + (cellHeight / 2);
              } else {
                const perRow = Math.ceil(Math.sqrt(count));
                const col = idx % perRow;
                const row = Math.floor(idx / perRow);
                x = baseX + (cellWidth / (perRow + 1)) * (col + 1);
                y = baseY + (cellHeight / (Math.ceil(count / perRow) + 1)) * (row + 1);
              }
              
              ctx.fillStyle = categoryColors[d.category] || '#f97316';
              ctx.beginPath();
              ctx.arc(x, y, markerSize, 0, Math.PI * 2);
              ctx.fill();
              
              ctx.fillStyle = '#fff';
              ctx.font = `bold ${Math.max(8, markerSize)}px Arial`;
              ctx.textAlign = 'center';
              ctx.fillText(d.defectNumber.toString(), x, y + (markerSize / 3));
            });
          });
          
          ctx.textAlign = 'left';
          ctx.fillStyle = '#666';
          ctx.font = '14px Arial';
          const legendY = gridStartY + gridHeight + 40;
          ctx.fillText('üü† Markers show defect locations (color = category)', margin, legendY);
          ctx.fillText('Numbers = defect IDs (see report for details)', margin, legendY + 25);
          
          canvas.toBlob((blob) => {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `defect-map-${face}-${projectId}-${new Date().toISOString().split('T')[0]}.png`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            downloadCount++;
            if (downloadCount === faces.length) {
              setTimeout(() => {
                alert('‚úÖ Generated 4 defect maps (one per face)!');
              }, 500);
            }
          }, 'image/png');
        }
      });
    }
  </script>
</body>
</html>